// BUILD-JS.JS
// ===============

// get dependencies
var fse = require('fs-extra');
var path = require('path');
const { minify } = require('terser');

// path consts
var ROOT = path.resolve(process.cwd());
var JS_MIN_FOLDER_PATH = path.join(ROOT, 'web/js/min');
var HEAD_JS_FOLDER = path.join(ROOT, 'web/js/head/');
var HEAD_JS_MIN_FILE_PATH = path.join(JS_MIN_FOLDER_PATH, 'site-head.js');

var headJs = "";
var headJsFiles = [];

// if head files are specified in the package, get file list from there
var packageFile = require(path.join(ROOT, 'package.json'));

if(packageFile['config']['project-base'] && packageFile['config']['project-base']['head']){
  packageFile['config']['project-base']['head'].forEach(function(file){
    headJsFiles.push(path.join(ROOT, file));
  });
}

//otherwise list files in js/head folder
else {

  fse.readdirSync(HEAD_JS_FOLDER).forEach(function(file){

    var filepath = path.join(HEAD_JS_FOLDER, file);

    if(file.match(/init\.js/)){
      headJsFiles.push(filepath);
    }
    else {
      headJsFiles.unshift(filepath);
    }

  });
}

// copy shared head js files over from project base
headJsFiles.forEach(function(file){
  headJs += fse.readFileSync(file);
});


(async () => {
  const result = await minify(headJs);

  // write files
  fse.writeFileSync(HEAD_JS_MIN_FILE_PATH, result.code, 'utf8');
})();

