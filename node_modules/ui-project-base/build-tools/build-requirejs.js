// BUILD-JS.JS
// ===============

// get dependencies
var fs = require('fs');
var path = require('path');
var requirejs = require('requirejs');

// get utility functions
var configtools = require('./config-tools.js');

// path consts
var ROOT = path.resolve(process.cwd());
var JS_MIN_FOLDER = '/js/min/';
var JS_MIN_FOLDER_PATH = path.join(ROOT, 'web', JS_MIN_FOLDER);

// get require js config file
var config = configtools.strip(fs.readFileSync(path.join(ROOT, 'web/require-config.js'), 'utf8').toString());

// create duplicate config file for minified paths
var configMin = JSON.parse(JSON.stringify(config));

// loop through config.paths and process each js file
Object.keys(config.paths).forEach(function(name, index){

  // add min path to config
  configMin.paths[name] = JS_MIN_FOLDER + name;

  // add absolute path to config.paths
  config.paths[name] = path.join(ROOT, 'web', config.paths[name]);

  // build js file
  requirejs.optimize({
    paths: config.paths,
    name: name,
    out: JS_MIN_FOLDER_PATH + name + '.js',
    generateSourceMaps: true,
    preserveLicenseComments: false
  });

});
