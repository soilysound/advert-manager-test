const fse = require('fs-extra');
const path = require('path');
const clc = require('cli-color');
const util = require('util');
const copyFilePromise = util.promisify(fse.copyFile);

// path consts
const ROOT = path.resolve(process.cwd());
const MODULES_FOLDER = path.join(ROOT, '/node_modules');
const UI_GRAPHICS_FOLDER = path.join(ROOT, 'web/assets/ui-graphics');
const UI_COMPONENT_IMAGES = path.join(ROOT, '/web/assets/ui-graphics');
const UI_COMPONENT_IMAGE_files = path.join(ROOT, '/web/assets/ui-graphics/*');
const UI_COMPONENT_GRAPHICS_PATH = '/assets/ui-graphics/';

function getDirectories(srcpath) {
  return fse.readdirSync(srcpath).filter(function(file) {
    return fse.statSync(path.join(srcpath, file)).isDirectory();
  });
}

// cli user feedback styles
const emphasise = clc.underline;
const notice = clc.blue;
const success = clc.green;

// check UI GRAPHICS folder exists
fse.ensureDir(UI_GRAPHICS_FOLDER, function (error) {
  if (error) throw error;
});
const COMPONENTS = getDirectories(MODULES_FOLDER);

// clean UI GRAPHICS folder of files
fse.removeSync(UI_COMPONENT_IMAGE_files);

function copyFiles(srcDir, destDir, files) {
  return Promise.all(files.map(f => {
    return copyFilePromise(path.join(srcDir, f), path.join(destDir, f));
  }));
}

// check components for UI GRAPHICS and copy to app for use
COMPONENTS.filter(item => item.match(/^ui-|sdc-|blackjack-/)).forEach(function(COMPONENTID, i){
  const srcDir = path.join(MODULES_FOLDER, COMPONENTID.replace(/^#{|}/g, ''), UI_COMPONENT_GRAPHICS_PATH);
  const destDir = UI_COMPONENT_IMAGES;

  fse.readdir(srcDir, function (err, files) {
    let fileList = [];
  
    if (err) {
      return;
    }

    console.log("🏞   " + notice('UI graphics ' + emphasise("found") + ' for ' + clc.blueBright(COMPONENTID) + '.'));
  
    files.forEach(function (file) {
        fileList.push(file);
    });
  
    copyFiles(srcDir, destDir, fileList).then(() => {
      console.log("✅  " + success(clc.greenBright(COMPONENTID) + " UI graphics " + emphasise("copied")+ "."));
    }).catch(err => {
      console.log(err);
    });
  });
});