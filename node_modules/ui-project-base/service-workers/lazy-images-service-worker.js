self.addEventListener('fetch', function(event) {
    // get request url and referrer
    var url = event.request.url;
    var referrer = event.request.referrer;

    // set interceptRequest to be true then query the url to see if it should be allowed
    var interceptRequest = true;

    // if the referrer is an AMP page or a css file, eg a background image, do not intercept
    // we cannot check or manipulate this image as its not in the dom
    if (referrer.match(/\/amp\//) || referrer.match(/\.css/) || !referrer) {
        interceptRequest = false;
    }

    // if it is not an image do not intercept
    // NOTE - if a jpg/png or svg is loaded from anything other than an img or source tag this may block the request
    if (!url.match(/\.jpg|\.jpeg|\.png|\.svg|\.webp/)) {
        interceptRequest = false;
    }

    // ignore urls that specifiy a sizing value using a : after the file type
    if (url.match(/\.jpg:|\.jpeg:|\.png:|\.gif:|\.svg:/)) {
        interceptRequest = false;
    }

    // ignore urls from 3rd parties
    if (url.match(/\.twimg|data\.shorthand\.com|img\.playbuzz\.com|storify\.com|images\.outbrainimg\.com|outbrain\.com|components\.news\.sky\.com\/shorthand|imagetesting\.chartbeat\.com/)) {
        interceptRequest = false;
    }

    // if it has the bypass-service-worker parameter do not intercept
    if (url.match(/bypass-service-worker/)) {
        interceptRequest = false;
    }

    // if it is from shorthand net storage
    if (url.match(/components\.news\.sky\.com\/shorthand/)) {
        interceptRequest = false;
    }

    // if interceptRequest is still true return a blank gif instead of going to the network
    if (interceptRequest) {
        event.respondWith(fetch('data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==').then(res => res));
    }
});
